let today=new Date,referenceDate=new Date,events=[],calendarName="",missingEntrySymbol="&#x2022;",categoriesAll;
function loadICS(a,e,p){categoriesAll=p;calendarName=e;fetch(a).then(f=>f.text()).then(f=>parseICS(f)).catch(f=>{console.error("FATAL ERROR: Fehler beim Laden der ICS-Datei:",f);parseICS("BEGIN:VCALENDAR\nEND:VCALENDAR");document.getElementById("error-message").innerHTML="Fehler beim Laden der Kalender-Quelldateien.<br/>Bitte kontaktieren Sie <div class='modal-center-container'>Termine-Mathe@ruhr-uni-bochum.de.</div>"})}
function parseICS(a){a=ICAL.parse(a);events=(new ICAL.Component(a)).getAllSubcomponents("vevent").map(e=>{if(!e.hasProperty("dtstart")||!e.hasProperty("summary"))return console.warn("WARNING: An event in the ics file was ignored because it does not contain a start date (DTSTART) or because it does not contain a summary (SUMMARY)."),{};let p=e.getFirstPropertyValue("summary"),f;try{f=e.getFirstPropertyValue("dtstart").toJSDate()}catch{return console.warn("WARNING: An event in the ics file was ignored because the date could not be converted into javascript format."),
{}}if(e.hasProperty("rrule"))return console.warn("WARNING: The event on "+f.toDateString()+" entitled '"+p+"' in the ics file was ignored because it is a recurring event (i.e. VEVENT contains an RRULE)."),{};let g=e.getFirstPropertyValue("description")||"",k=e.getFirstPropertyValue("location")||missingEntrySymbol,b=[];try{e.getAllProperties("categories").forEach(q=>{cats=q.jCal;cats=cats.slice(3,cats.length);b=b.concat(cats)})}catch{return console.warn("WARNING: The event on "+f.toDateString()+" entitled '"+
p+"' in the ics file was ignored because its event categories could not be parsed."),{}}b=b.map(q=>q.trim().replace(/[ ]+/g," "));0==b.length&&b.push("none");let r=b[0],t=!1,h=!1,l;try{l=e.getFirstPropertyValue("dtend").toJSDate()}catch{h=t=!0,l=f}if(!t){e=f.toLocaleTimeString("de",{hour:"2-digit",minute:"2-digit"});let q=l.toLocaleTimeString("de",{hour:"2-digit",minute:"2-digit"});"00:00"==q&&(l.setMinutes(l.getMinutes()-1),q="23:59");f.toDateString()==l.toDateString()&&"00:00"==e&&"23:59"==q&&(h=
t=!0);f.toDateString()!=l.toDateString()&&(t=!0)}t&&f.setHours(23,59,59,999);return{summary:p,description:g,allDayEvent:t,singleDayEvent:h,startDate:f,endDate:l,location:k,mainCategory:r,allCategories:b}});events=events.filter(e=>0<Object.keys(e).length);displayCalendar()}
function displayCalendar(){var a=(referenceDate.getMonth()+3)%6;let e=new Date(referenceDate.valueOf());e.setMonth(e.getMonth()-a);e.setDate(1);e.setHours(0,0,0,0);let p=new Date(referenceDate.valueOf());p.setMonth(p.getMonth()-a+6);p.setDate(0);p.setHours(23,59,59,999);a=!0;e.getYear();3==e.getMonth()&&(a=!1);let f=new Date(p.valueOf());f.setHours(0,0,0,0);document.getElementById("calendar-header").innerHTML="";let g=document.createElement("button");g.classList.add("setting-buttons");g.title="linke Pfeiltaste dr\u00fccken";
g.innerHTML="< Fr\u00fcheres Semester";g.addEventListener("click",function(){changeTerm(-1)});document.getElementById("calendar-header").appendChild(g);g=document.createElement("div");g.id="calendar-title";g.title="springe zum aktuellen Semester";g.addEventListener("click",function(u){BackToToday()});g.innerHTML=calendarName;g.innerHTML=a?g.innerHTML+("<br>Wintersemester "+e.toLocaleString("de-DE",{year:"numeric"})+"\u00ad/"+p.toLocaleString("de-DE",{year:"numeric"})):g.innerHTML+("<br>Sommersemester "+
e.toLocaleString("de-DE",{year:"numeric"}));document.getElementById("calendar-header").appendChild(g);g=document.createElement("button");g.classList.add("setting-buttons");g.title="rechte Pfeiltaste dr\u00fccken";g.addEventListener("click",function(){changeTerm(1)});g.innerHTML="N\u00e4chstes Semester >";document.getElementById("calendar-header").appendChild(g);a=document.getElementById("calendar-semesterview");a.innerHTML="";var k=document.createElement("colgroup"),b=document.createElement("col");
b.classList.add("semesterview-col-date");k.appendChild(b);b=document.createElement("col");b.classList.add("semesterview-col-time");k.appendChild(b);b=document.createElement("col");b.classList.add("semesterview-col-summary");k.appendChild(b);b=document.createElement("col");b.classList.add("semesterview-col-location");k.appendChild(b);a.appendChild(k);k=document.createElement("thead");k.id="table-head";b=document.createElement("th");b.textContent="Datum";b.classList.add("semesterview-day");k.appendChild(b);
b=document.createElement("th");b.textContent="Uhrzeit";k.appendChild(b);b=document.createElement("th");b.textContent="Beschreibung";k.appendChild(b);b=document.createElement("th");b.textContent="Ort";k.appendChild(b);a.appendChild(k);k=events.filter(u=>u.endDate<e||u.startDate>p?!1:categoriesAll.includes(u.mainCategory));let r=document.createElement("tbody"),t=!0;for(b=0;365>b;b++){var h=f.toDateString()==today.toDateString(),l=k.filter(c=>c.startDate.toDateString()===f.toDateString()||f>=c.startDate&&
f<=c.endDate);l.sort((c,m)=>c.startDate-m.startDate);let u=l.length;if(h){let c=document.createElement("tr");h=document.createElement("td");h.colSpan="4";let m=document.createElement("hr");h.appendChild(m);c.appendChild(h);r.appendChild(c);c=document.createElement("tr");c.classList.add("today-separator");c.classList.add("today-separator-top");h=document.createElement("td");h.colSpan="4";m=document.createElement("hr");h.appendChild(m);c.appendChild(h);r.appendChild(c);c=document.createElement("tr");
h=document.createElement("td");h.classList.add("semesterview-day");1<u&&(h.rowSpan=u);h.classList.add("semesterview-today-date");h.innerHTML="heute<br>"+f.toLocaleDateString("de",{weekday:"short",month:"numeric",day:"numeric"});c.appendChild(h);var q=!0;l.forEach(d=>{t=!1;q?q=!1:c=document.createElement("tr");let n=document.createElement("td");n.classList.add("semesterview-event","semesterview-event-time","semesterview-today-event");n.innerHTML=d.allDayEvent?missingEntrySymbol:d.startDate.toLocaleTimeString("de",
{hour:"2-digit",minute:"2-digit"})+"<br>\u2013<br>"+d.endDate.toLocaleTimeString("de",{hour:"2-digit",minute:"2-digit"});c.appendChild(n);n=document.createElement("td");n.classList.add("semesterview-event","semesterview-event-summary","semesterview-today-event","today-event");g=document.createElement("b");g.innerHTML=d.summary;n.appendChild(g);g=document.createElement("p");g.innerHTML=d.description.replace(/(?:\r\n|\r|\n)/g,"<br>");n.appendChild(g);c.appendChild(n);n=document.createElement("td");
n.classList.add("semesterview-event","semesterview-event-location","semesterview-today-event");n.innerHTML=d.location;c.appendChild(n);r.appendChild(c)});0==u&&(l=document.createElement("td"),c.appendChild(l),l=document.createElement("td"),l.innerHTML="<i> \u2014 keine Veranstaltungen \u2014</i>",l.classList.add("no-events-to-display"),c.appendChild(l),r.appendChild(c));c=document.createElement("tr");c.classList.add("today-separator");c.classList.add("today-separator-bottom");h=document.createElement("td");
h.colSpan="4";m=document.createElement("hr");h.appendChild(m);c.appendChild(h);r.appendChild(c)}else q=!0,l.forEach(c=>{t=!1;let m=document.createElement("tr");if(q){q=!1;var d=document.createElement("td");d.colSpan="4";let n=document.createElement("hr");d.appendChild(n);m.appendChild(d);r.appendChild(m);m=document.createElement("tr");d=document.createElement("td");f<today?d.classList.add("semesterview-day-past"):d.classList.add("semesterview-day");d.rowSpan=u;d.textContent=f.toLocaleDateString("de",
{weekday:"short",month:"numeric",day:"numeric"});m.appendChild(d)}d=document.createElement("td");f<today?d.classList.add("semesterview-event-past","semesterview-event-time"):d.classList.add("semesterview-event","semesterview-event-time");c.allDayEvent?d.innerHTML=missingEntrySymbol:d.textContent=c.startDate.toLocaleTimeString("de",{hour:"2-digit",minute:"2-digit"});d.addEventListener("click",function(){openModal(c)});m.appendChild(d);d=document.createElement("td");f<today?d.classList.add("semesterview-event-past",
"semesterview-event-summary"):d.classList.add("semesterview-event","semesterview-event-summary");d.innerHTML=c.summary;d.addEventListener("click",function(){openModal(c)});m.appendChild(d);d=document.createElement("td");f<today?d.classList.add("semesterview-event-past","semesterview-event-location"):d.classList.add("semesterview-event","semesterview-event-location");d.innerHTML=c.location;d.addEventListener("click",function(){openModal(c)});m.appendChild(d);r.appendChild(m)});f.setDate(f.getDate()-
1);if(f<e)break}t&&(document.getElementById("table-head").classList.add("hide-me"),k=document.createElement("tr"),b=document.createElement("td"),b.colSpan="4",b.innerHTML="<i>\u2014 keine Veranstaltungen eingetragen \u2014</i>",k.appendChild(b),r.appendChild(k));a.appendChild(r)}
function openModal(a){document.body.classList.add("no-scroll");a.singleDayEvent?document.getElementById("modal-title").textContent=a.startDate.toLocaleDateString("de-de",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):a.allDayEvent?document.getElementById("modal-title").textContent=a.startDate.toLocaleDateString("de-de",{weekday:"long",year:"numeric",month:"long",day:"numeric"})+" \u2013 "+a.endDate.toLocaleDateString("de-de",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):
document.getElementById("modal-title").textContent=a.startDate.toLocaleDateString("de-de",{weekday:"long",year:"numeric",month:"long",day:"numeric"})+", "+a.startDate.toLocaleTimeString("de-de",{hour:"numeric",minute:"2-digit"})+"\u2013"+a.endDate.toLocaleTimeString("de-de",{hour:"numeric",minute:"2-digit"});document.getElementById("modal-body").innerHTML="";el=document.createElement("div");el.classList.add("eventsummary");el.innerHTML=a.summary;document.getElementById("modal-body").appendChild(el);
el=document.createElement("div");el.classList.add("eventlocation");el.innerHTML=a.location==missingEntrySymbol?"Ort unbekannt":a.location;document.getElementById("modal-body").appendChild(el);el=document.createElement("p");el.classList.add("eventabstract");el.innerHTML=linkifyStr(a.description,{className:"linkInAbstract"}).replace(/(?:\r\n|\r|\n)/g,"<br>");document.getElementById("modal-body").appendChild(el);document.getElementById("modal-body").appendChild(closeModalButton());document.getElementById("event-modal").style.display=
"flex"}function closeModalButton(){let a=document.createElement("div");a.classList.add("modal-center-container");let e=document.createElement("button");e.classList.add("toggle-buttons","setting-buttons");e.innerHTML="Schlie\u00dfen";e.addEventListener("click",function(){document.getElementById("event-modal").style.display="none";document.body.classList.remove("no-scroll")});a.appendChild(e);return a}
document.getElementById("event-modal").addEventListener("click",function(a){a.currentTarget===a.target&&(document.getElementById("event-modal").style.display="none",document.body.classList.remove("no-scroll"))});function changeTerm(a){referenceDate.setMonth(referenceDate.getMonth()+6*a);displayCalendar()}document.addEventListener("keydown",logKey);function logKey(a){"37"==a.which?changeTerm(-1):"39"==a.which&&changeTerm(1)}
function BackToToday(){today=new Date;referenceDate=new Date;displayCalendar()}function updateToday(){(new Date).toDateString()!=today.toDateString()&&(today=new Date,referenceDate=new Date,displayCalendar())}setInterval(updateToday,6E4);
